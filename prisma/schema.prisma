generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ========================================
// RBAC CORE MODELS
// ========================================

model Role {
  id              String           @id @default(cuid())
  name            String           @unique
  description     String?
  isSystemRole    Boolean          @default(false)
  rolePermissions RolePermission[]
  userRoles       UserRole[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model Permission {
  id              String           @id @default(cuid())
  key             String           @unique
  description     String?
  category        String?
  rolePermissions RolePermission[]
  userPermissions UserPermission[] // ⭐ NEW: User-specific permission grants
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

// ========================================
// ORGANIZATION MODELS
// ========================================

model Company {
  id            String        @id @default(cuid())
  code          String        @unique
  name          String
  status        Boolean       @default(true)
  userRoles     UserRole[]
  userCompanies UserCompany[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Area {
  id          String     @id @default(cuid())
  code        String     @unique
  name        String
  location    String
  status      AreaStatus @default(ACTIVE)
  description String?
  polygon     String?
  parentId    String?

  parent    Area?      @relation("AreaHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children  Area[]     @relation("AreaHierarchy")
  buildings Building[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([status])
}

enum AreaStatus {
  ACTIVE
  INACTIVE
  DEVELOPMENT
}

// ========================================
// BUILDING (MINIMAL - FOR RBAC)
// ========================================

model Building {
  id             String  @id @default(cuid())
  code           String  @unique
  name           String
  areaId         String
  buildingTypeId String? // Optional FK to BuildingType
  status         Boolean @default(true)

  // Location Details
  address   String? // Full address text
  latitude  Float? // GPS Latitude coordinate
  longitude Float? // GPS Longitude coordinate

  area          Area            @relation(fields: [areaId], references: [id], onDelete: Cascade)
  buildingType  BuildingType?   @relation(fields: [buildingTypeId], references: [id], onDelete: SetNull)
  userBuildings UserBuilding[]
  images        BuildingImage[] // Building photos
  rooms         Room[] // Rooms in this building

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete timestamp
  deletedBy String? // Username who deleted

  @@index([areaId])
  @@index([buildingTypeId])
  @@index([status])
  @@index([deletedAt])
}

// ========================================
// BUILDING TYPE (MASTER DATA)
// ========================================

model BuildingType {
  id          String  @id @default(cuid())
  code        String  @unique
  name        String
  description String?

  // Default Settings untuk Building
  defaultMaxFloors  Int      @default(5)
  defaultFacilities String[] @default([])
  icon              String? // Icon identifier (optional)

  status    Boolean    @default(true)
  buildings Building[] // Relation to buildings

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([code])
}

// ========================================
// ROOM TYPE (MASTER DATA)
// ========================================

model RoomType {
  id          String  @id @default(cuid())
  code        String  @unique
  name        String
  description String?

  // Bed Configuration
  bedsPerRoom      Int      @default(1) // Jumlah bed dalam 1 room
  defaultBedType   String // "Single Bed", "Double Bed", "Bunk Bed"
  defaultAmenities String[] @default([]) // Default fasilitas kamar
  priceMultiplier  Float    @default(1.0) // Multiplier untuk pricing

  // Visual (optional)
  icon     String?
  imageUrl String?

  status Boolean @default(true)

  rooms Room[] // Rooms using this type

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([code])
}

// ========================================
// USER ACCESS MODELS
// ========================================

// Central User Table
model User {
  id          String  @id @default(cuid())
  username    String  @unique // NIK is stored here
  usernameKey String  @unique // Lowercase version for case-insensitive lookup
  displayName String
  email       String  @unique
  avatarUrl   String?

  status    Boolean   @default(true) // active/inactive
  lastLogin DateTime?

  // ⭐ Audit Trail (stores username for readability)
  createdBy String? // Username who created this record
  createdAt DateTime  @default(now())
  updatedBy String? // Username who last updated this record
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete timestamp
  deletedBy String? // Username who deleted this record

  // Relations
  userRoles       UserRole[]
  userPermissions UserPermission[] // User-specific permission overrides
  userCompanies   UserCompany[]
  userBuildings   UserBuilding[]
  notifications   NotificationRecipient[]
  occupant        Occupant? // Link to occupant record for stay history

  @@index([usernameKey])
  @@index([email])
  @@index([status])
  @@index([deletedAt]) // ⭐ For efficient soft delete queries
}

// User Role Assignment (with optional company scope)
model UserRole {
  id String @id @default(cuid())

  userId    String
  roleId    String
  companyId String? // Optional: Role scoped to specific company

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role    Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  assignedAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, roleId, companyId])
  @@index([userId])
  @@index([roleId])
  @@index([companyId])
}

// User Company Access
model UserCompany {
  id String @id @default(cuid())

  userId    String
  companyId String

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  grantedAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
}

// User Building Access
model UserBuilding {
  id String @id @default(cuid())

  userId     String
  buildingId String

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  grantedAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, buildingId])
  @@index([userId])
  @@index([buildingId])
}

// ========================================
// USER PERMISSION (USER-SPECIFIC GRANTS)
// ========================================

// User-Specific Permission Overrides
// Purpose: Grant additional permissions to users outside their assigned roles
// Use Cases: Temporary elevated access, exceptions, granular control
model UserPermission {
  id           String @id @default(cuid())
  userId       String
  permissionId String

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  // Audit Trail
  grantedBy String? // Admin who granted this permission
  reason    String? // Why this permission was granted
  expiresAt DateTime? // Optional expiration date for temporary permissions

  // Timestamps
  grantedAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
  @@index([expiresAt]) // For efficient cleanup queries
}

// ========================================
// SYSTEM CONFIGURATION
// ========================================

model SystemSetting {
  id        Int      @id @default(1) // Singleton ID
  config    Json // Stores all system configuration (General, Booking, Notifications, etc.)
  updatedAt DateTime @updatedAt
}

// ==========================================
// NOTIFICATION SYSTEM
// ==========================================

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum NotificationCategory {
  SYSTEM
  BOOKING
  MAINTENANCE
}

model Notification {
  id        String               @id @default(cuid())
  title     String
  message   String               @db.Text
  type      NotificationType     @default(INFO)
  category  NotificationCategory @default(SYSTEM)
  link      String?
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  recipients NotificationRecipient[]

  @@map("notifications")
}

model NotificationRecipient {
  id             String    @id @default(cuid())
  notificationId String
  userId         String
  isRead         Boolean   @default(false)
  readAt         DateTime?
  createdAt      DateTime  @default(now())

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([notificationId])
  @@map("notification_recipients")
}

// ==========================================
// BOOKING SYSTEM ENUMS
// ==========================================

enum OccupantType {
  EMPLOYEE
  GUEST
}

enum AllowedOccupantType {
  EMPLOYEE_ONLY
  ALL
}

enum RoomStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

enum GenderPolicy {
  MALE_ONLY
  FEMALE_ONLY
  MIX
  FLEXIBLE
}

enum BookingStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum OccupancyStatus {
  PENDING
  RESERVED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
  NO_SHOW
}

enum Gender {
  MALE
  FEMALE
}

enum OccupancyLogAction {
  CREATED
  CHECKED_IN
  DATE_CHANGED
  TRANSFERRED
  EARLY_CHECKOUT
  CHECKED_OUT
  CANCELLED
  STATUS_CHANGED
}

// ==========================================
// OCCUPANT (Master Data for People)
// ==========================================

model Occupant {
  id   String       @id @default(cuid())
  type OccupantType // EMPLOYEE | GUEST

  // Link to User (for EMPLOYEE type)
  // When userId is set, this occupant is an employee and can see their stay history
  userId String? @unique

  // Identity (NIK is unique - one person = one record)
  nik    String @unique // NIK for employee, KTP for guest
  name   String
  gender Gender

  // Contact
  phone String?
  email String?

  // Company Info (snapshot for guests, or from User for employees)
  company    String?
  department String?
  position   String?

  // Photo
  photoUrl String?

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  // Relations
  user  User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  stays Occupancy[] // All stays (current + history)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([type])
  @@index([nik])
  @@index([deletedAt])
  @@map("occupants")
}

// ==========================================
// BUILDING IMAGE
// ==========================================

model BuildingImage {
  id         String @id @default(cuid())
  buildingId String

  // File Storage
  fileName String // Original filename (e.g. "foto-gedung.jpg")
  filePath String // Storage path or URL (e.g. "/uploads/buildings/abc123.webp")
  fileSize Int // File size in bytes (after compression)
  mimeType String @default("image/webp") // Final mime type

  // Image Metadata
  width  Int? // Image width in pixels
  height Int? // Image height in pixels

  // Display
  caption   String?
  isPrimary Boolean @default(false)
  order     Int     @default(0)

  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([buildingId])
  @@index([isPrimary])
  @@map("building_images")
}

// ==========================================
// ROOM
// ==========================================

model Room {
  id         String @id @default(cuid())
  buildingId String
  roomTypeId String

  code        String  @unique
  name        String
  floorNumber Int     @default(1)
  description String?

  // Access Control
  allowedOccupantType AllowedOccupantType @default(ALL)
  isBookable          Boolean             @default(true)

  // Gender Policy
  genderPolicy  GenderPolicy @default(MIX)
  currentGender String? // "MALE" | "FEMALE" | null (for FLEXIBLE rooms)

  // Pricing
  pricePerBed Decimal? @db.Decimal(12, 2)

  status RoomStatus @default(ACTIVE)

  // Relations
  building Building    @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  roomType RoomType    @relation(fields: [roomTypeId], references: [id])
  beds     Bed[]
  images   RoomImage[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete timestamp
  deletedBy String? // Username who deleted

  @@index([buildingId])
  @@index([buildingId, floorNumber])
  @@index([roomTypeId])
  @@index([status])
  @@index([allowedOccupantType])
  @@index([isBookable])
  @@index([deletedAt])
  @@map("rooms")
}

// ==========================================
// ROOM IMAGE
// ==========================================

model RoomImage {
  id     String @id @default(cuid())
  roomId String

  // File Storage
  fileName String // Original filename
  filePath String // Storage path or URL
  fileSize Int // File size in bytes (after compression)
  mimeType String @default("image/webp") // Final mime type

  // Image Metadata
  width  Int? // Image width in pixels
  height Int? // Image height in pixels

  // Display
  caption   String?
  isPrimary Boolean @default(false)
  order     Int     @default(0)

  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([roomId])
  @@index([isPrimary])
  @@map("room_images")
}

// ==========================================
// BED
// ==========================================

model Bed {
  id     String @id @default(cuid())
  roomId String

  code     String  @unique
  label    String
  position Int
  bedType  String?
  notes    String?

  room         Room                 @relation(fields: [roomId], references: [id], onDelete: Cascade)
  occupancies  Occupancy[]
  requestItems BookingRequestItem[] // Pending booking requests for this bed

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete timestamp
  deletedBy String? // Username who deleted

  @@index([roomId])
  @@index([deletedAt])
  @@map("beds")
}

// ==========================================
// BOOKING
// ==========================================

model Booking {
  id   String @id @default(cuid())
  code String @unique

  // Requester Info (SNAPSHOT - no FK to Company)
  requesterUserId     String
  requesterName       String
  requesterNik        String?
  requesterEmail      String?
  requesterPhone      String?
  requesterCompany    String? // Snapshot, not FK
  requesterDepartment String?
  requesterPosition   String?

  // Companion Info (Required if has GUEST occupant)
  companionUserId     String?
  companionName       String?
  companionNik        String?
  companionEmail      String?
  companionPhone      String?
  companionCompany    String?
  companionDepartment String?

  purpose     String?
  projectCode String?

  // Status
  status BookingStatus @default(PENDING)

  // Approval
  approvedBy String?
  approvedAt DateTime?

  // Rejection
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?

  // Cancellation
  cancelledBy        String?
  cancelledAt        DateTime?
  cancellationReason String?

  notes String?

  // Relations
  occupancies  Occupancy[]
  requestItems BookingRequestItem[] // Structured pending request items
  attachments  BookingAttachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([requesterUserId])
  @@index([status])
  @@map("bookings")
}

// ==========================================
// BOOKING REQUEST ITEM (Pending Items - Before Approval)
// ==========================================
// Stores individual bed requests before admin approval.
// This table enables efficient conflict checking without
// polluting the main Occupancy table with unconfirmed data.

model BookingRequestItem {
  id String @id @default(cuid())

  // Parent Booking
  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  // Requested Bed
  bedId String
  bed   Bed    @relation(fields: [bedId], references: [id])

  // Occupant Data (Snapshot - not FK to Occupant table)
  name       String
  nik        String?
  gender     Gender
  type       OccupantType // EMPLOYEE | GUEST
  email      String?
  phone      String?
  company    String?
  department String?

  // Requested Stay Dates
  checkInDate  DateTime
  checkOutDate DateTime

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes for optimal query performance
  @@index([bookingId])
  @@index([bedId])
  @@index([checkInDate])
  @@index([checkOutDate])
  @@index([bedId, checkInDate, checkOutDate]) // Composite for conflict checking
  @@map("booking_request_items")
}

// ==========================================
// BOOKING ATTACHMENT
// ==========================================

model BookingAttachment {
  id        String @id @default(cuid())
  bookingId String

  fileName    String
  fileUrl     String
  fileType    String
  fileSize    Int
  description String?

  uploadedBy     String
  uploadedByName String

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([bookingId])
  @@map("booking_attachments")
}

// ==========================================
// OCCUPANCY
// ==========================================

model Occupancy {
  id         String  @id @default(cuid())
  bookingId  String? // Nullable - NULL means direct placement by admin
  occupantId String // Reference to master Occupant data
  bedId      String

  // Stay Period (can be different from Booking dates, but within range)
  // checkOutDate is optional - NULL means indefinite stay (e.g., employees, special guests)
  checkInDate          DateTime  @db.Date
  checkOutDate         DateTime? @db.Date
  originalCheckOutDate DateTime? @db.Date // Stored if date was changed
  actualCheckIn        DateTime?
  actualCheckOut       DateTime?

  // Status
  status OccupancyStatus @default(PENDING)
  qrCode String?         @unique

  // Audit - Created (for direct placement)
  createdBy     String?
  createdByName String?

  // Transfer Info (for tracking bed changes within same stay)
  transferredFromBedId String?
  transferReason       String?
  transferredAt        DateTime?
  transferredBy        String?
  transferredByName    String?

  // Cancellation fields for booking
  cancelledAt     DateTime?
  cancelledBy     String?
  cancelledByName String?
  cancelledReason String?

  // Checkout Info
  checkoutReason String?
  checkoutBy     String?
  checkoutByName String?

  notes String?

  // Relations
  occupant Occupant       @relation(fields: [occupantId], references: [id])
  booking  Booking?       @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  bed      Bed            @relation(fields: [bedId], references: [id])
  logs     OccupancyLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([occupantId])
  @@index([bookingId])
  @@index([bedId])
  @@index([status])
  @@index([checkInDate])
  @@index([checkOutDate])
  @@map("occupancies")
}

// ==========================================
// OCCUPANCY LOG (AUDIT TRAIL)
// ==========================================

model OccupancyLog {
  id          String @id @default(cuid())
  occupancyId String

  // Context: Where did this action occur?
  // For non-transfer actions, this is the bed where action happened
  // For transfers, use fromBedId/toBedId instead
  bedId String?

  action OccupancyLogAction

  // Transfer details (only for TRANSFERRED action)
  fromBedId String?
  toBedId   String?

  // Date change details
  previousCheckInDate  DateTime? @db.Date
  newCheckInDate       DateTime? @db.Date
  previousCheckOutDate DateTime? @db.Date
  newCheckOutDate      DateTime? @db.Date

  // Performer
  performedBy     String
  performedByName String
  performedAt     DateTime @default(now())

  // Details
  reason   String?
  notes    String?
  metadata Json?

  occupancy Occupancy @relation(fields: [occupancyId], references: [id], onDelete: Cascade)

  @@index([occupancyId])
  @@index([bedId])
  @@index([fromBedId])
  @@index([toBedId])
  @@index([action])
  @@index([performedAt])
  @@map("occupancy_logs")
}
